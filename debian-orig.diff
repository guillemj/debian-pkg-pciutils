--- pciutils-3.0.2.orig/pcimodules.man
+++ pciutils-3.0.2/pcimodules.man
@@ -0,0 +1,92 @@
+.TH pcimodules 8 "@TODAY@" "@VERSION@" "Linux PCI Utilities"
+.IX pcimodules
+.SH NAME
+pcimodules \- List kernel driver modules available for all currently plugged
+in PCI devices
+.SH SYNOPSIS
+.B pcimodules
+.RB [ --class class_id ]
+.RB [ --classmask mask ]
+.RB [ --help ]
+.SH DESCRIPTION
+.B pcimodules
+lists all driver modules for all currently plugged in PCI devices.
+.B pcimodules
+should be run at boot time, and whenever a PCI device is "hot plugged"
+into the system.  This can be done by the following Bourne shell syntax:
+.IP
+	for module in $(pcimodules) ; do
+.IP
+		modprobe -s -k "$module"
+.IP
+	done
+.PP
+When a PCI device is removed from the system, the Linux kernel will
+decrement a usage count on PCI driver module.  If this count drops
+to zero (i.e., there are no PCI drivers), then the
+.B modprobe -r
+process that is normally configured to run from cron every few minutes
+will eventually remove the unneeded module.
+.PP
+The --class and --classmask arguments can be used to limit the search
+to certain classes of PCI devices.  This is useful, for example, to
+generate a list of ethernet card drivers to be loaded when the kernel
+has indicated that it is trying to resolve an unknown network interface.
+.PP
+Modules are listed in the order in which the PCI devices are physically
+arranged so that the computer owner can arrange things like having scsi
+device 0 be on a controller that is not alphabetically the first scsi
+controller.
+.SH OPTIONS
+.TP
+.B --class class --classmask mask
+.PP
+--class and --classmask limit the search to PCI
+cards in particular classes.  These arguments are always used together.
+The arguments to --class and --classmask
+can be given as hexadecimal numbers by prefixing a leading "0x".
+Note that the classes used by pcimodules are in "Linux" format,
+meaning the class value that you see with lspci would be shifted
+left eight bits, with the new low eight bits programming interface ID.
+An examples of how to use class and classmask is provided below.
+.B --help, -h
+Print a help message and exit.
+.SH EXAMPLES
+.TP
+pcimodules
+lists all modules corresponding to currently plugged in PCI devices.
+.TP
+pcimodules --class 0x20000 --classmask 0xffff00
+lists all modules corresponding to currently plugged in ethernet PCI devices.
+.SH FILES
+.TP
+.B /lib/modules/<kernel-version>/modules.pcimap
+This file is automatically generated by
+.B depmod,
+and used by
+.B pcimodules
+to determine which modules correspond to which PCI ID's.
+.TP
+.B /proc/bus/pci
+An interface to PCI bus configuration space provided by the post-2.1.82 Linux
+kernels. Contains per-bus subdirectories with per-card config space files and a
+.I devices
+file containing a list of all PCI devices.
+
+.SH SEE ALSO
+.BR lspci (8)
+
+.SH MAINTAINER
+The Linux PCI Utilities are maintained by Martin Mares <mj@suse.cz>.
+
+.SH AUTHOR
+.B pcimodules
+was written by Adam J. Richter <adam@yggdrasil.com>, based on public
+domain example code by Martin Mares <mj@suse.cz>.
+
+.SH COPYRIGHT
+.B pcimodules
+is copyright 2000, Yggdrasil Computing, Incorporated, and may
+be copied under the terms and conditions of version 2 of the GNU
+General Public License as published by the Free Software Foundation
+(Cambridge, Massachusetts, United States of America).
--- pciutils-3.0.2.orig/pci.ids
+++ pciutils-3.0.2/pci.ids
@@ -11,7 +11,7 @@
 #	This file can be distributed under either the GNU General Public License
 #	(version 2 or higher) or the 3-clause BSD License.
 #
-#	Daily snapshot on Thu 2008-09-11 01:05:01
+#	Daily snapshot on Sat 2008-10-04 01:05:02
 #
 
 # Vendors, devices and subsystems. Please keep sorted.
@@ -1014,7 +1014,7 @@
 		1014 029a  Remote Supervisor Adapter II (RSA2)
 		1014 02c8  eServer xSeries server mainboard
 		1028 016c  PowerEdge 1850
-		1028 016d  PowerEdge 2850
+		1028 016d  PowerEdge 2850 Embedded Radeon 7000-M
 		1028 019a  PowerEdge SC1425
 		103c 1292  Radeon 7000
 		1043 c00a  A7000/T/64M
@@ -1030,9 +1030,9 @@
 	515e  ES1000
 		1028 01df  PowerEdge SC440
 		1028 01e6  PowerEdge 860
-		1028 020f  PowerEdge R300
-		1028 0210  PowerEdge T300
-		1028 0225  PWA-Pandora Motherboard [PowerEdge T105]
+		1028 020f  PowerEdge R300 Embedded ATI ES1000
+		1028 0210  PowerEdge T300 Embedded ATI ES1000
+		1028 0225  PowerEdge T105 Embedded ATI ES1000
 		15d9 8680  X7DVL-E-O motherboard
 		8086 3476  S5000PSLSATA Server Board
 	515f  ES1000
@@ -1447,8 +1447,10 @@
 	940b  R600GL [Fire GL V8600]
 	9440  RV770 [Radeon HD 4870]
 	9442  RV770 [Radeon HD 4850]
-	94c1  Radeon HD 2400 XT
+	9490  RV730XT [Radeon HD 4670]
+	94c1  RV610 [Radeon HD 2400 XT]
 		1028 0211  Optiplex 755
+		1028 0d02  Optiplex 755
 	94c3  RV610 video device [Radeon HD 2400 PRO]
 		1002 94c3  Radeon HD 2400PRO
 		174b e400  Sapphire HD 2400 PRO video device
@@ -1467,7 +1469,7 @@
 	9511  RV670 [FireGL 7700]
 	9515  RV670 AGP [Radeon HD 3850]
 	9519  RV670 [FireStream 9170]
-	9559  Mobilitiy Radeon HD 3600 Series
+	9559  Mobility Radeon HD 3600 Series
 	9581  M76 [Radeon Mobility HD 2600 Series]
 	9586  RV 630 XT AGP [Radeon HD 2600 XT AGP]
 	9587  RV630 PRO AGP [Radeon HD 2600 PRO AGP]
@@ -1475,17 +1477,18 @@
 		1458 216c  Radeon HD 2600 XT, 256MB GDDR3, 2x DVI, TV-out, PCIe (GV-RX26T256H)
 	9589  RV630 [Radeon HD 2600 Series]
 	958c  RV630GL [FireGL v5600]
-	9591  Mobilitiy Radeon HD 3650
+	9591  Mobility Radeon HD 3650
 		1002 9591  Mobility Radeon HD 3650
 	9593  Radeon Mobility HD 3670
+	9595  M86GL [Mobility FireGL V5700]
 	9596  RV635 PRO AGP [Radeon HD 3650]
-	9598  Mobilitiy Radeon HD 3600 Series
+	9598  Mobility Radeon HD 3600 Series
 		1002 9598  Mobility Radeon HD 3600
-	95c0  Mobilitiy Radeon HD 3470
+	95c0  Mobility Radeon HD 3470
 		1002 95c0  Mobility Radeon HD 3470
-	95c4  Mobilitiy Radeon HD 3400 Series
+	95c4  Mobility Radeon HD 3400 Series
 		1002 95c4  Mobility Radeon HD 3400
-	95c5  Mobilitiy Radeon HD 3450
+	95c5  Mobility Radeon HD 3450
 		1002 95c5  Mobility Radeon HD 3450
 	95c6  RV620 LE AGP [Radeon HD 3450]
 	960f  RS780 Azalia controller
@@ -6156,6 +6159,7 @@
 		1043 8042  A7V133/A7V133-C Mainboard
 		147b a401  KT7/KT7-RAID/KT7A/KT7A-RAID Mainboard
 	0308  PT880 Ultra/PT894 Host Bridge
+		1043 8199  P4V800D-X Mainboard
 	0314  CN700/VN800/P4M800CE/Pro Host Bridge
 	0324  CX700/VX700 Host Bridge
 	0327  P4M890 Host Bridge
@@ -6163,7 +6167,7 @@
 	0340  PT900 Host Bridge
 	0351  K8T890CF Host Bridge
 	0353  VX800 Host Bridge
-	0364  P4M900 Host Bridge
+	0364  CN896/VN896/P4M900 Host Bridge
 		1043 81ce  P5VD2-VM mothervoard
 	0391  VT8371 [KX133]
 	0415  PATA IDE Host Controller
@@ -6245,7 +6249,7 @@
 	1340  PT900 Host Bridge
 	1351  VT3351 Host Bridge
 	1353  VX800/VX820 Error Reporting
-	1364  P4M900 Host Bridge
+	1364  CN896/VN896/P4M900 Host Bridge
 	1571  VT82C576M/VT82C586
 	1595  VT82C595/97 [Apollo VP2/97]
 	2106  VIA Rhine Family Fast Ethernet Adapter (VT6105)
@@ -6267,7 +6271,7 @@
 	2340  PT900 Host Bridge
 	2351  VT3351 Host Bridge
 	2353  VX800/VX820 Host Bus Control
-	2364  P4M900 Host Bridge
+	2364  CN896/VN896/P4M900 Host Bridge
 	287a  VT8251 PCI to PCI Bridge
 	287b  VT8251 Host Bridge
 	287c  VT8251 PCIE Root Port
@@ -6352,6 +6356,7 @@
 		147b 1407  KV8-MAX3 motherboard
 		1695 300c  EP-8KRA2+ Mainboard
 		1849 0850  ASRock 775Dual-880 Pro onboard audio (Realtek ALC850)
+		1849 9739  P4VT8 Mainboard (C-Media CMI9739A codec)
 		1849 9761  K7VT6 motherboard
 		4005 4710  MSI K7T266 Pro2-RU (MSI-6380 v2) onboard audio (Realtek/ALC 200/200P)
 		a0a0 01b6  AK77-8XN onboard audio
@@ -6434,6 +6439,7 @@
 		1043 80f4  P4P800 Mainboard Deluxe ATX
 		1462 7028  915P/G Neo2
 	3168  P4X333/P4X400/PT800 AGP Bridge
+		1849 3168  P4VT8 Mainboard
 	3177  VT8235 ISA Bridge
 		1019 0a81  L7VTA v1.0 Motherboard (KT400-8235)
 		1043 808c  A7V8X motherboard
@@ -6489,8 +6495,8 @@
 	3349  VT8251 AHCI/SATA 4-Port Controller
 	3351  VT3351 Host Bridge
 	3353  VX800 PCI to PCI Bridge
-	3364  P4M900 Host Bridge
-	3371  P4M900 [Chrome 9 HC]
+	3364  CN896/VN896/P4M900 Host Bridge
+	3371  CN896/VN896/P4M900 [Chrome 9 HC]
 	3372  VT8237S PCI to ISA Bridge
 	337a  VT8237A PCI to PCI Bridge
 	337b  VT8237A Host Bridge
@@ -6513,7 +6519,7 @@
 	4340  PT900 Host Bridge
 	4351  VT3351 Host Bridge
 	4353  VX800/VX820 Power Management Control
-	4364  P4M900 Host Bridge
+	4364  CN896/VN896/P4M900 Host Bridge
 	5030  VT82C596 ACPI [Apollo PRO]
 	5208  PT890 I/O APIC Interrupt Controller
 	5238  K8T890 I/O APIC Interrupt Controller
@@ -6524,12 +6530,13 @@
 	5336  K8M890CE I/O APIC Interrupt Controller
 	5340  PT900 I/O APIC Interrupt Controller
 	5351  VT3351 I/O APIC Interrupt Controller
-	5364  P4M900 I/O APIC Interrupt Controller
+	5353  VX800/VX820 APIC and Central Traffic Control
+	5364  CN896/VN896/P4M900 I/O APIC Interrupt Controller
 	6100  VT85C100A [Rhine II]
 	6287  SATA RAID Controller
 	6327  P4M890 Security Device
 	6353  VX800/VX820 Scratch Registers
-	6364  P4M900 Security Device
+	6364  CN896/VN896/P4M900 Security Device
 	7204  K8M800 Host Bridge
 	7205  KM400/KN400/P4M800 [S3 UniChrome]
 		1458 d000  Gigabyte GA-7VM400(A)M(F) Motherboard
@@ -6551,7 +6558,7 @@
 	7340  PT900 Host Bridge
 	7351  VT3351 Host Bridge
 	7353  VX800/VX820 North-South Module Interface Control
-	7364  P4M900 Host Bridge
+	7364  CN896/VN896/P4M900 Host Bridge
 	8231  VT8231 [PCI-to-ISA Bridge]
 	8235  VT8235 ACPI
 	8305  VT8363/8365 [KT133/KM133 AGP]
@@ -6579,7 +6586,7 @@
 	a238  K8T890 PCI to PCI Bridge Controller
 	a327  P4M890 PCI to PCI Bridge Controller
 	a353  VX800/VX820 South-North Module Interface Control
-	a364  P4M900 PCI to PCI Bridge Controller
+	a364  CN896/VN896/P4M900 PCI to PCI Bridge Controller
 	b091  VT8633 [Apollo Pro266 AGP]
 	b099  VT8366/A/7 [Apollo KT266/A/333 AGP]
 	b101  VT8653 AGP Bridge
@@ -6599,7 +6606,7 @@
 	c327  P4M890 PCI to PCI Bridge Controller
 	c340  PT900 PCI to PCI Bridge Controller
 	c353  VX800/VX820 PCI Express Root Port
-	c364  P4M900 PCI to PCI Bridge Controller
+	c364  CN896/VN896/P4M900 PCI to PCI Bridge Controller
 	d104  VT8237R USB UDCI Controller
 	d208  PT890 PCI to PCI Bridge Controller
 	d213  VPX/VPX2 PCI to PCI Bridge Controller
@@ -7247,8 +7254,11 @@
 	0034  AccelePort 2r 920
 	0035  DataFire DSP T1/E1/PRI cPCI
 	0040  AccelePort Xp
+# AccelePort Xp 2 ports
 		114f 0042  AccelePort 2p PCI
+# AccelePort Xp 4 ports
 		114f 0043  AccelePort 4p PCI
+# AccelePort Xp 8 ports
 		114f 0044  AccelePort 8p PCI
 	0042  AccelePort 2p
 	0043  AccelePort 4p
@@ -10138,6 +10148,7 @@
 		103c 7055  NC382i Integrated Quad Port PCI Express Gigabit Server Adapter
 		103c 7059  NC382T PCI Express Dual Port Multifunction Gigabit Server Adapter
 	163a  NetXtreme II BCM5709S Gigabit Ethernet
+# ice
 		103c 171d  NC382m Dual Port 1GbE Multifunction BL-c Adapter
 		103c 7056  NC382i Integrated Quad Port PCI Express Gigabit Server Adapter
 	163b  NetXtreme II BCM5716 Gigabit Ethernet
@@ -10479,6 +10490,7 @@
 		1414 0003  Wireless Notebook Adapter MN-720
 		1414 0004  Wireless PCI Adapter MN-730
 	4326  BCM4307 Chipcommon I/O Controller?
+# This should be the correct naming
 	4328  BCM4328 802.11a/b/g/n
 		1028 0009  Wireless 1500 Draft 802.11n WLAN Mini-Card
 		1028 000a  Wireless 1500 Draft 802.11n WLAN Mini-card
@@ -12013,13 +12025,18 @@
 4040  NetXen Incorporated
 	0001  NXB-10GXSR 10 Gigabit Ethernet PCIe Adapter with SR-XFP optical interface
 		103c 7047  NC510F PCIe 10 Gigabit Server Adapter
-		103c 7048  NC510C PCIe 10 Gigabit Server Adapter
 	0002  NXB-10GCX4 10 Gigabit Ethernet PCIe Adapter with CX4 copper interface
+		103c 7048  NC510c PCIe 10Gigabit Server Adapter
 	0003  NXB-4GCU Quad Gigabit Ethernet PCIe Adapter with 1000-BASE-T interface
 	0004  BladeCenter-H 10 Gigabit Ethernet High Speed Daughter Card
 	0005  NetXen Dual Port 10GbE Multifunction Adapter for c-Class
+		103c 170e  NC512m Dual Port 10GbE Multifunction BL-C Adapter
 	0024  XG Mgmt
 	0025  XG Mgmt
+	0100  NX3031 Multifunction 1/10 Gigabit Server Adapter
+		103c 171b  NC522m Dual Port 10GbE Multifunction BL-c Adapter
+		103c 705a  NC375i Integrated Quad Port Multifunction Gigabit Server Adapter
+		103c 705b  NC522SFP Dual Port 10GbE Server Adapter
 4143  Digital Equipment Corp
 4144  Alpha Data
 	0044  ADM-XRCIIPro
@@ -12300,6 +12317,9 @@
 	0007  82379AB
 	0008  Extended Express System Support Controller
 	0039  21145 Fast Ethernet
+	0040  Auburndale/Havendale DRAM Controller
+	0041  Auburndale/Havendale PCI Express x16 Root Port
+	0042  Auburndale/Havendale Integrated Graphics Controller
 	0122  82437FX
 	0309  80303 I/O Processor PCI-to-PCI Bridge
 	030d  80312 I/O Companion Chip PCI-to-PCI Bridge
@@ -12565,13 +12585,12 @@
 		8086 105e  PRO/1000 PT Dual Port Network Connection
 		8086 10d5  82571PT Gigabit PT Quad Port Server ExpressModule
 		8086 115e  PRO/1000 PT Dual Port Server Adapter
-		8086 116e  PRO/1000 PT Dual Port Server Adapter
 		8086 125e  PRO/1000 PT Dual Port Server Adapter
 		8086 135e  PRO/1000 PT Dual Port Server Adapter
 	105f  82571EB Gigabit Ethernet Controller
 		103c 704f  Dual Port 1000Base-SX (PCIe) [AD338A]
+		8086 005a  PRO/1000 PF Dual Port Server Adapter
 		8086 115f  PRO/1000 PF Dual Port Server Adapter
-		8086 116f  PRO/1000 PF Dual Port Server Adapter
 		8086 125f  PRO/1000 PF Dual Port Server Adapter
 		8086 135f  PRO/1000 PF Dual Port Server Adapter
 	1060  82571EB Gigabit Ethernet Controller
@@ -13151,6 +13170,7 @@
 	244e  82801 PCI Bridge
 		1014 0267  NetVista A30p
 		1028 0211  Optiplex 755
+		1458 5000  GA-EP45-DS5 Motherboard
 	2450  82801E ISA Bridge (LPC)
 	2452  82801E USB Controller
 	2453  82801E SMBus Controller
@@ -13298,6 +13318,7 @@
 		103c 088c  NC8000 laptop
 		103c 0890  NC6000 laptop
 		103c 08b0  tc1100 tablet
+		1043 1713  M6800N
 		1043 80b0  P4B533
 		1071 8160  MIM2000
 		1179 0201  Toshiba Tecra M1
@@ -13305,7 +13326,6 @@
 		144d c00c  P30/P35 notebook
 		1458 a002  GA-8PE667 Ultra
 		1462 5800  845PE Max (MS-6580)
-		1713 1043  Asus M6800N
 		1734 1005  D1451 (SCENIC N300, i845GV) Sigmatel STAC9750T
 		1734 1055  Amilo M1420
 		8086 24c5  Dell Dimension 2400
@@ -13320,12 +13340,12 @@
 		103c 088c  NC8000 laptop
 		103c 0890  NC6000 laptop
 		103c 08b0  tc1100 tablet
+		1043 1826  M6800N
 		1071 8160  MIM2000
 		144d 2115  X10 Laptop
 		144d c00c  P30/P35 notebook
 # Conexant HSF Softmodem (CXT22)
 		14f1 5422  D480 MDC V.9x Modem
-		1826 1043  Asus M6800N
 	24c7  82801DB/DBL/DBM (ICH4/ICH4-L/ICH4-M) USB UHCI Controller #3
 		1014 0267  NetVista A30p
 		1014 052d  ThinkPad
@@ -13423,7 +13443,7 @@
 		1014 02ed  eServer xSeries server mainboard
 		1028 0169  Precision 470
 		1028 016c  PowerEdge 1850
-		1028 016d  PowerEdge 2850
+		1028 016d  PowerEdge 2850 onboard UHCI
 		1028 0183  PowerEdge 1800
 		1028 019a  PowerEdge SC1425
 		103c 006a  NX9500
@@ -13459,7 +13479,7 @@
 		1014 02ed  eServer xSeries server mainboard
 		1028 0169  Precision 470
 		1028 016c  PowerEdge 1850
-		1028 016d  PowerEdge 2850
+		1028 016d  PowerEdge 2850 onboard UHCI
 		1028 0183  PowerEdge 1800
 		1028 019a  PowerEdge SC1425
 		103c 006a  NX9500
@@ -13482,7 +13502,7 @@
 		1043 80f3  P4P800 Mainboard
 		1043 810f  P5P800-MX Mainboard
 		1458 a002  GA-8IPE1000/8KNXP motherboard
-		1462 0080  65PE Neo2-V (MS-6788) mainboard
+		1462 0080  865PE Neo2-V (MS-6788) Mainboard
 		1462 7280  865PE Neo2 (MS-6728)
 		8086 a000  D865PERL mainboard
 		8086 e000  D865PERL mainboard
@@ -13494,7 +13514,7 @@
 		1014 02ed  xSeries server mainboard
 		1028 0169  Precision 470
 		1028 016c  PowerEdge 1850
-		1028 016d  PowerEdge 2850
+		1028 016d  PowerEdge 2850 onboard UHCI
 		1028 0183  PowerEdge 1800
 		103c 006a  NX9500
 		103c 12bc  d530 CMT (DG746A)
@@ -13513,7 +13533,7 @@
 		1014 02ed  eServer xSeries server mainboard
 		1028 0169  Precision 470
 		1028 016c  PowerEdge 1850
-		1028 016d  PowerEdge 2850
+		1028 016d  PowerEdge 2850 onboard UHCI
 		1028 019a  PowerEdge SC1425
 		103c 006a  NX9500
 		103c 12bc  d530 CMT (DG746A)
@@ -13535,7 +13555,7 @@
 		1014 02ed  eServer xSeries server mainboard
 		1028 0169  Precision 470
 		1028 016c  PowerEdge 1850
-		1028 016d  PowerEdge 2850
+		1028 016d  PowerEdge 2850 onboard EHCI
 		1028 0183  PowerEdge 1800
 		1028 019a  PowerEdge SC1425
 		103c 006a  NX9500
@@ -13620,6 +13640,7 @@
 		1028 019d  Dimension 3000
 		103c 12bc  D530 sff(dc578av)
 		1043 80a5  P5P800-MX Mainboard
+		1734 101b  Fujitsu-Siemens Scenic E300 i865GV
 		8086 4246  Desktop Board D865GBF
 		8086 4c43  Desktop Board D865GLC
 	2573  82865G/PE/P PCI to CSA Bridge
@@ -13925,6 +13946,7 @@
 		1028 0177  Dimension 8400
 		1028 0179  Optiplex GX280
 		1028 0182  Latitude D610 Laptop
+		1028 0187  Dell Precision M70 Laptop
 		1028 0188  Inspiron 6000 laptop
 		103c 0934  Compaq nw8240/nx8220
 		103c 0944  Compaq NC6220
@@ -14030,6 +14052,7 @@
 		8086 544e  DeskTop Board D945GTP
 	27b8  82801GB/GR (ICH7 Family) LPC Interface Bridge
 		1028 01e6  PowerEdge 860
+		1043 8179  P5KPL-VM Motherboard
 		107b 5048  E4500
 		8086 544e  DeskTop Board D945GTP
 	27b9  82801GBM (ICH7-M) LPC Interface Bridge
@@ -14045,6 +14068,7 @@
 		1028 01ad  OptiPlex GX620
 		1028 01df  PowerEdge SC440
 		1028 01e6  PowerEdge 860
+		1043 8179  P5KPL-VM Motherboard
 		107b 5048  E4500
 		1462 2310  MSI Hetis 945
 		1462 7236  945P Neo3-F Rev. 2.2 motherboard
@@ -14070,6 +14094,7 @@
 		1028 01e6  PowerEdge 860
 		103c 30a1  NC2400
 		103c 30a3  Compaq nw8440
+		1043 8179  P5KPL-VM Motherboard
 		107b 5048  E4500
 		17aa 200a  ThinkPad T60/R60 series
 		8086 544e  DeskTop Board D945GTP
@@ -14081,6 +14106,7 @@
 		1028 01e6  PowerEdge 860
 		103c 30a1  NC2400
 		103c 30a3  Compaq nw8440
+		1043 8179  P5KPL-VM Motherboard
 		107b 5048  E4500
 		17aa 200a  ThinkPad T60/R60 series
 		8086 544e  DeskTop Board D945GTP
@@ -14092,6 +14118,7 @@
 		1028 01e6  PowerEdge 860
 		103c 30a1  NC2400
 		103c 30a3  Compaq nw8440
+		1043 8179  P5KPL-VM Motherboard
 		107b 5048  E4500
 		17aa 200a  ThinkPad T60/R60 series
 		8086 544e  DeskTop Board D945GTP
@@ -14102,6 +14129,7 @@
 		1028 01df  PowerEdge SC440
 		103c 30a1  NC2400
 		103c 30a3  Compaq nw8440
+		1043 8179  P5KPL-VM Motherboard
 		107b 5048  E4500
 		17aa 200a  ThinkPad T60/R60 series
 		8086 544e  DeskTop Board D945GTP
@@ -14113,6 +14141,7 @@
 		1028 01e6  PowerEdge 860
 		103c 30a1  NC2400
 		103c 30a3  Compaq nw8440
+		1043 8179  P5KPL-VM Motherboard
 		17aa 200b  ThinkPad T60/R60 series
 		8086 544e  DeskTop Board D945GTP
 	27d0  82801G (ICH7 Family) PCI Express Port 1
@@ -14128,26 +14157,28 @@
 		103c 30a1  NC2400
 		103c 30a3  Compaq nw8440
 		1043 13c4  Asus G2P
+		1043 8290  P5KPL-VM Motherboard
 		107b 5048  E4500
 		10f7 8338  Panasonic CF-Y5 laptop
 		1179 ff10  Toshiba Satellite A100-796 audio (Realtek ALC861)
 		1179 ff31  AC97 Data Fax SoftModem with SmartCP
+		1458 a102  GA-8I945PG-RH Mainboard
 		152d 0753  Softmodem
 		1734 10ad  Conexant softmodem SmartCP
 		17aa 2010  ThinkPad T60/R60 series
 		17aa 3802  Lenovo 3000 C200 audio [Realtek ALC861VD]
 		8086 1112  DeskTop Board D945GTP
 		8086 27d8  DeskTop Board D945GTP
-		a102 1458  DeskTop Board Gigabyte GA-8I945PG-RH
 	27da  82801G (ICH7 Family) SMBus Controller
 		1025 006c  9814 WKMI
 		1028 01ad  OptiPlex GX620
 		1028 01d7  XPS M1210
 		1028 01df  PowerEdge SC440
 		1028 01e6  PowerEdge 860
+		1043 8179  P5KPL-VM Motherboard
 		10f7 8338  Panasonic CF-Y5 laptop
+		1458 5001  GA-8I945PG-RH Mainboard
 		17aa 200f  ThinkPad T60/R60 series
-		5001 1458  DeskTop Board Gigabyte GA-8I945PG-RH
 		8086 544e  DeskTop Board D945GTP
 		8086 5842  DeskTop Board D975XBX
 	27dc  82801G (ICH7 Family) LAN Controller
@@ -14161,6 +14192,7 @@
 		1028 01e6  PowerEdge 860
 		103c 30a1  NC2400
 		103c 30a3  Compaq nw8440
+		1043 8179  P5KPL-VM Motherboard
 		107b 5048  E4500
 		10f7 8338  Panasonic CF-Y5 laptop
 		17aa 200c  ThinkPad T60/R60 series
@@ -14171,6 +14203,7 @@
 		1043 81ec  P5B
 	2811  82801HBM (ICH8M-E) LPC Interface Controller
 		103c 30c1  Compaq 6910p
+		17aa 20b6  T61
 		e4bf cc47  CCG-RUMBA
 	2812  82801HH (ICH8DH) LPC Interface Controller
 	2814  82801HO (ICH8DO) LPC Interface Controller
@@ -14305,6 +14338,7 @@
 		0690 107b  Gateway P-6825
 		1025 011f  Realtek ALC268 audio codec
 		1025 0121  Aspire 5920G
+		1025 0145  Realtek ALC889 (Aspire 8920G w. Dolby Theather)
 		1028 01da  OptiPlex 745
 		1028 01f3  Inspiron 1420
 		1028 01f9  Dell Latitude D630
@@ -14312,8 +14346,10 @@
 		103c 2802  HP Compaq dc7700p
 		103c 30c0  Compaq 6710b
 		103c 30c1  Compaq 6910p
+		1043 1339  Asus M51S series
 		1043 81ec  P5B
 		104d 9005  Vaio VGN-FZ260E
+		104d 9016  Sony VAIO VGN-AR51M
 		14f1 5051  Presario C700
 		17aa 20ac  ThinkPad T61
 		8384 7616  Dell Vostro 1400
@@ -14335,10 +14371,10 @@
 	2918  82801IB (ICH9) LPC Interface Controller
 	2919  ICH9M LPC Interface Controller
 	2920  82801IR/IO/IH (ICH9R/DO/DH) 4 port SATA IDE Controller
-		1028 020f  PowerEdge R300
-		1028 0210  PowerEdge T300
+		1028 020f  PowerEdge R300 onboard SATA Controller
+		1028 0210  PowerEdge T300 onboard SATA Controller
 		1028 0211  Optiplex 755
-		1028 023c  PowerEdge R200
+		1028 023c  PowerEdge R200 onboard SATA Controller
 	2921  82801IB (ICH9) 2 port SATA IDE Controller
 	2922  82801IR/IO/IH (ICH9R/DO/DH) 6 port SATA AHCI Controller
 	2923  82801IB (ICH9) 4 port SATA AHCI Controller
@@ -14346,6 +14382,8 @@
 		1734 10e0  System Board D2542
 		8086 2925  System Board D2542
 	2926  82801I (ICH9 Family) 2 port SATA IDE Controller
+		1028 020f  Dell PowerEdge R300
+		1028 0210  Dell PowerEdge R300
 		1028 0211  Optiplex 755
 	2928  ICH9M/M-E 2 port SATA IDE Controller
 	2929  ICH9M/M-E SATA AHCI Controller
@@ -14356,17 +14394,17 @@
 		1028 0211  Optiplex 755
 	2932  82801I (ICH9 Family) Thermal Subsystem
 	2934  82801I (ICH9 Family) USB UHCI Controller #1
-		1028 020f  PowerEdge R300
-		1028 0210  PowerEdge T300
+		1028 020f  PowerEdge R300 onboard UHCI
+		1028 0210  PowerEdge T300 onboard UHCI
 		1028 0211  Optiplex 755
 		1028 2011  Optiplex 755
 	2935  82801I (ICH9 Family) USB UHCI Controller #2
-		1028 020f  PowerEdge R300
-		1028 0210  PowerEdge T300
+		1028 020f  PowerEdge R300 onboard UHCI
+		1028 0210  PowerEdge T300 onboard UHCI
 		1028 0211  Optiplex 755
 	2936  82801I (ICH9 Family) USB UHCI Controller #3
-		1028 020f  PowerEdge R300
-		1028 0210  PowerEdge T300
+		1028 020f  PowerEdge R300 onboard UHCI
+		1028 0210  PowerEdge T300 onboard UHCI
 		1028 0211  Optiplex 755
 	2937  82801I (ICH9 Family) USB UHCI Controller #4
 		1028 0211  Optiplex 755
@@ -14379,8 +14417,8 @@
 	2939  82801I (ICH9 Family) USB UHCI Controller #6
 		1028 0210  PowerEdge T300
 	293a  82801I (ICH9 Family) USB2 EHCI Controller #1
-		1028 020f  PowerEdge R300
-		1028 0210  PowerEdge T300
+		1028 020f  PowerEdge R300 onboard EHCI
+		1028 0210  PowerEdge T300 onboard EHCI
 		1028 0211  Optiplex 755
 	293c  82801I (ICH9 Family) USB2 EHCI Controller #2
 		1028 0211  Optiplex 755
@@ -14448,9 +14486,12 @@
 	29b7  82Q35 Express Serial KT Controller
 		1028 0211  OptiPlex 755
 	29c0  82G33/G31/P35/P31 Express DRAM Controller
+		1043 82b0  P5KPL-VM Motherboard
 	29c1  82G33/G31/P35/P31 Express PCI Express Root Port
 	29c2  82G33/G31 Express Integrated Graphics Controller
+		1043 82b0  P5KPL-VM Motherboard
 	29c3  82G33/G31 Express Integrated Graphics Controller
+		1043 82b0  P5KPL-VM Motherboard
 	29c4  82G33/G31/P35/P31 Express MEI Controller
 	29c5  82G33/G31/P35/P31 Express MEI Controller
 	29c6  82G33/G31/P35/P31 Express PT IDER Controller
@@ -14486,6 +14527,7 @@
 		103c 30d9  Presario C700
 		104d 9005  Vaio VGN-FZ260E
 		17aa 20b1  ThinkPad T61
+		17aa 20b3  T61
 		e4bf cc47  CCG-RUMBA
 	2a01  Mobile PM965/GM965/GL960 PCI Express Root Port
 	2a02  Mobile GM965/GL960 Integrated Graphics Controller
@@ -14493,11 +14535,13 @@
 		1028 01f9  Latitude D630
 		103c 30c0  Compaq 6710b
 		103c 30d9  Presario C700
+		17aa 20b5  T61
 		e4bf cc47  CCG-RUMBA
 	2a03  Mobile GM965/GL960 Integrated Graphics Controller
 		1028 01f3  Dell Inspiron 1420
 		103c 30c0  Compaq 6710b
 		103c 30d9  Presario C700
+		17aa 20b5  T61
 		e4bf cc47  CCG-RUMBA
 	2a04  Mobile PM965/GM965 MEI Controller
 		103c 30c1  Compaq 6910p
@@ -14568,13 +14612,16 @@
 	2e16  4 Series Chipset PT IDER Controller
 	2e17  4 Series Chipset Serial KT Controller
 	2e20  4 Series Chipset DRAM Controller
+		1458 5000  GA-EP45-DS5 Motherboard
 	2e21  4 Series Chipset PCI Express Root Port
+		1458 5000  GA-EP45-DS5 Motherboard
 	2e22  4 Series Chipset Integrated Graphics Controller
 	2e23  4 Series Chipset Integrated Graphics Controller
 	2e24  4 Series Chipset HECI Controller
 	2e25  4 Series Chipset HECI Controller
 	2e26  4 Series Chipset PT IDER Controller
 	2e27  4 Series Chipset Serial KT Controller
+	2e29  4 Series Chipset PCI Express Root Port
 	2e30  4 Series Chipset DRAM Controller
 	2e31  4 Series Chipset PCI Express Root Port
 	2e32  4 Series Chipset Integrated Graphics Controller
@@ -14726,10 +14773,12 @@
 		1775 ce90  CE9
 		4c53 10b0  CL9 mainboard
 		4c53 10e0  PSL09 PrPMC
+	358c  82854 GMCH
+	358e  82854 GMCH Integrated Graphics Device
 	3590  E7520 Memory Controller Hub
 		1014 02dd  eServer xSeries server mainboard
 		1028 016c  PowerEdge 1850
-		1028 016d  PowerEdge 2850
+		1028 016d  PowerEdge 2850=20
 		1028 019a  PowerEdge SC1425
 		1734 103e  PRIMERGY RX/TX S2 series
 		1775 1100  CR11/VR11 Single Board Computer
@@ -14783,29 +14832,45 @@
 	3a06  ICH10 2 port SATA IDE Controller
 	3a14  ICH10 LPC Interface Controller
 	3a16  82801JIR (ICH10R) LPC Interface Controller
+		1458 5001  GA-EP45-DS5 Motherboard
 	3a18  82801JIB (ICH10) LPC Interface Controller
 	3a1a  ICH10 LPC Interface Controller
 	3a20  82801JI (ICH10 Family) 4 port SATA IDE Controller
 	3a22  82801JI (ICH10 Family) SATA AHCI Controller
+		1458 b005  GA-EP45-DS5 Motherboard
 	3a25  82801JIR (ICH10R) SATA RAID Controller
 	3a26  82801JI (ICH10 Family) 2 port SATA IDE Controller
 	3a30  82801JI (ICH10 Family) SMBus Controller
+		1458 5001  GA-EP45-DS5 Motherboard
 	3a32  82801JI (ICH10 Family) Thermal Subsystem
 	3a34  82801JI (ICH10 Family) USB UHCI Controller #1
+		1458 5004  GA-EP45-DS5 Motherboard
 	3a35  82801JI (ICH10 Family) USB UHCI Controller #2
+		1458 5004  GA-EP45-DS5 Motherboard
 	3a36  82801JI (ICH10 Family) USB UHCI Controller #3
+		1458 5004  GA-EP45-DS5 Motherboard
 	3a37  82801JI (ICH10 Family) USB UHCI Controller #4
+		1458 5004  GA-EP45-DS5 Motherboard
 	3a38  82801JI (ICH10 Family) USB UHCI Controller #5
+		1458 5004  GA-EP45-DS5 Motherboard
 	3a39  82801JI (ICH10 Family) USB UHCI Controller #6
+		1458 5004  GA-EP45-DS5 Motherboard
 	3a3a  82801JI (ICH10 Family) USB2 EHCI Controller #1
+		1458 5006  GA-EP45-DS5 Motherboard
 	3a3c  82801JI (ICH10 Family) USB2 EHCI Controller #2
+		1458 5006  GA-EP45-DS5 Motherboard
 	3a3e  82801JI (ICH10 Family) HD Audio Controller
+		1458 a102  GA-EP45-DS5 Motherboard
 	3a40  82801JI (ICH10 Family) PCI Express Port 1
+		1458 5001  GA-EP45-DS5 Motherboard
 	3a42  82801JI (ICH10 Family) PCI Express Port 2
 	3a44  82801JI (ICH10 Family) PCI Express Port 3
 	3a46  82801JI (ICH10 Family) PCI Express Port 4
+		1458 5001  GA-EP45-DS5 Motherboard
 	3a48  82801JI (ICH10 Family) PCI Express Port 5
+		1458 5001  GA-EP45-DS5 Motherboard
 	3a4a  82801JI (ICH10 Family) PCI Express Port 6
+		1458 5001  GA-EP45-DS5 Motherboard
 	3a4c  82801JI (ICH10 Family) Gigabit Ethernet Controller
 	3a51  ICH10 VECI Controller
 	3a55  ICH10 Virtual SATA Controller
@@ -14921,14 +14986,14 @@
 	4032  5400 Chipset IOxAPIC
 	4035  5400 Chipset FBD Registers
 	4036  5400 Chipset FBD Registers
-	4220  PRO/Wireless 2200BG Network Connection
+	4220  PRO/Wireless 2200BG [Calexico2] Network Connection
 		103c 0934  Compaq nw8240/nx8220
 		103c 12f6  Compaq nw8240/nx8220
 		8086 2712  IBM ThinkPad R50e
 		8086 2721  Dell B130 laptop integrated WLAN
 		8086 2722  Dell Latitude D600
 		8086 2731  Samsung P35 integrated WLAN
-	4222  PRO/Wireless 3945ABG Network Connection
+	4222  PRO/Wireless 3945ABG [Golan] Network Connection
 		103c 135c  Compaq 6710b
 		103c 30c0  Compaq 6710b
 		8086 1000  PRO/Wireless 3945ABG Network Connection
@@ -14937,20 +15002,31 @@
 		8086 1034  PRO/Wireless 3945BG Network Connection
 		8086 1044  PRO/Wireless 3945BG Network Connection
 		8086 1c00  PRO/Wireless 3945ABG Network Connection
-	4223  PRO/Wireless 2915ABG Network Connection
+	4223  PRO/Wireless 2915ABG [Calexico2] Network Connection
 		1000 8086  mPCI 3B Americas/Europe ZZA
 		1001 8086  mPCI 3B Europe ZZE
 		1002 8086  mPCI 3B Japan ZZJ
 		1003 8086  mPCI 3B High-Band ZZH
 		1351 103c  Compaq NC6220
-	4224  PRO/Wireless 2915ABG Network Connection
-	4227  PRO/Wireless 3945ABG Network Connection
+	4224  PRO/Wireless 2915ABG [Calexico2] Network Connection
+	4227  PRO/Wireless 3945ABG [Golan] Network Connection
 		8086 1011  ThinkPad R60e/X60s
 		8086 1014  PRO/Wireless 3945BG Network Connection
-	4229  PRO/Wireless 4965 AG or AGN Network Connection
-	4230  PRO/Wireless 4965 AG or AGN Network Connection
+	4229  PRO/Wireless 4965 AG or AGN [Kedron] Network Connection
+	4230  PRO/Wireless 4965 AG or AGN [Kedron] Network Connection
 		8086 1110  Lenovo ThinkPad T51
 		8086 1111  Lenovo ThinkPad T61
+	4232  Wireless WiFi Link 5100
+		8086 1205  PRO/Wireless 5100BG Network Connection
+		8086 1206  PRO/Wireless 5100ABG Network Connection
+		8086 1216  PRO/Wireless 5100ABG Network Connection
+		8086 1305  PRO/Wireless 5100BG Network Connection
+		8086 1306  PRO/Wireless 5100ABG Network Connection
+		8086 1326  PRO/Wireless 5100ABG Network Connection
+	4235  PRO/Wireless 5300 AGN [Shiloh] Network Connection
+	4236  Wireless WiFi Link 5100
+	4237  PRO/Wireless 5100 AGN [Shiloh] Network Connection
+	423a  PRO/Wireless 5350 AGN [Echo Peak] Network Connection
 	444e  Turbo Memory Controller
 	5001  LE80578
 	5002  LE80578 Graphics Processor Unit
@@ -15155,6 +15231,22 @@
 		4c53 1050  CT7 mainboard
 		4c53 1051  CE7 mainboard
 		e4bf 1000  CC8-1-BLUES
+	d130  Clarksfield/Lynnfield DMI
+	d131  Clarksfield/Lynnfield DMI
+	d132  Clarksfield/Lynnfield DMI
+	d133  Clarksfield/Lynnfield DMI
+	d134  Clarksfield/Lynnfield DMI
+	d135  Clarksfield/Lynnfield DMI
+	d136  Clarksfield/Lynnfield DMI
+	d137  Clarksfield/Lynnfield DMI
+	d138  Clarksfield/Lynnfield PCI Express Root Port 1
+	d139  Lynnfield PCI Express Root Port 2
+	d13a  Clarksfield/Lynnfield PCI Express Root Port 3
+	d13b  Lynnfield PCI Express Root Port 4
+	d155  Clarksfield/Lynnfield System Management Registers
+	d156  Clarksfield/Lynnfield Semaphore and Scratchpad Registers
+	d157  Clarksfield/Lynnfield System Control and Status Registers
+	d158  Clarksfield/Lynnfield Miscellaneous Registers
 80ee  InnoTek Systemberatung GmbH
 	beef  VirtualBox Graphics Adapter
 	cafe  VirtualBox Guest Service
--- pciutils-3.0.2.orig/Makefile
+++ pciutils-3.0.2/Makefile
@@ -1,7 +1,7 @@
 # Makefile for The PCI Utilities
 # (c) 1998--2008 Martin Mares <mj@ucw.cz>
 
-OPT=-O2
+OPT=-O2 -g
 CFLAGS=$(OPT) -Wall -W -Wno-parentheses -Wstrict-prototypes -Wmissing-prototypes
 
 VERSION=3.0.2
@@ -50,7 +50,9 @@
 
 export
 
-all: lib/$(PCILIB) lspci setpci example lspci.8 setpci.8 pcilib.7 update-pciids update-pciids.8 $(PCI_IDS)
+pcimod-$(PCI_OS_LINUX) := pcimodules
+pcimod8-$(PCI_OS_LINUX) := pcimodules.8
+all: lib/$(PCILIB) lspci lspci-udeb setpci example lspci.8 setpci.8 pcilib.7 update-pciids update-pciids.8 $(PCI_IDS) $(pcimod-1) $(pcimod8-1)
 
 lib/$(PCILIB): $(PCIINC) force
 	$(MAKE) -C lib all
@@ -61,14 +63,17 @@
 	cd lib && ./configure
 
 lspci: lspci.o common.o lib/$(PCILIB)
+lspci-udeb: lspci.o common.o lib/libpci.a
 setpci: setpci.o common.o lib/$(PCILIB)
+pcimodules: pcimodules.o common.o lib/$(PCILIB)
 
 lspci.o: lspci.c pciutils.h $(PCIINC)
 setpci.o: setpci.c pciutils.h $(PCIINC)
+pcimodules.o: pcimodules.c pciutils.h $(PCIINC)
 common.o: common.c pciutils.h $(PCIINC)
 
 update-pciids: update-pciids.sh
-	sed <$< >$@ "s@^DEST=.*@DEST=$(IDSDIR)/$(PCI_IDS)@;s@^PCI_COMPRESSED_IDS=.*@PCI_COMPRESSED_IDS=$(PCI_COMPRESSED_IDS)@"
+	sed <$< >$@ "s@^FILE=.*@FILE=$(IDSDIR)/pci.ids@"
 	chmod +x $@
 
 # The example of use of libpci
@@ -78,12 +83,16 @@
 %: %.o
 	$(CC) $(LDFLAGS) $(TARGET_ARCH) $^ $(LDLIBS) -o $@
 
+lspci-udeb: lspci.o
+	$(CC) $(LDFLAGS) $(TARGET_ARCH) $^ $(LDLIBS) -lz -lresolv -o $@
+
 %.8 %.7: %.man
 	M=`echo $(DATE) | sed 's/-01-/-January-/;s/-02-/-February-/;s/-03-/-March-/;s/-04-/-April-/;s/-05-/-May-/;s/-06-/-June-/;s/-07-/-July-/;s/-08-/-August-/;s/-09-/-September-/;s/-10-/-October-/;s/-11-/-November-/;s/-12-/-December-/;s/\(.*\)-\(.*\)-\(.*\)/\3 \2 \1/'` ; sed <$< >$@ "s/@TODAY@/$$M/;s/@VERSION@/pciutils-$(VERSION)/;s#@IDSDIR@#$(IDSDIR)#"
 
 clean:
 	rm -f `find . -name "*~" -o -name "*.[oa]" -o -name "\#*\#" -o -name TAGS -o -name core -o -name "*.orig"`
 	rm -f update-pciids lspci setpci example lib/config.* *.[78] pci.ids.* lib/*.pc lib/*.so lib/*.so.*
+	rm -f pcimodules
 	rm -rf maint/dist
 
 distclean: clean
@@ -91,10 +100,11 @@
 install: all
 # -c is ignored on Linux, but required on FreeBSD
 	$(DIRINSTALL) -m 755 $(DESTDIR)$(SBINDIR) $(DESTDIR)$(IDSDIR) $(DESTDIR)$(MANDIR)/man8 $(DESTDIR)$(MANDIR)/man7
-	$(INSTALL) -c -m 755 $(STRIP) lspci setpci $(DESTDIR)$(SBINDIR)
+	$(INSTALL) -c -m 755 $(STRIP) lspci setpci $(pcimod-1) $(DESTDIR)$(SBINDIR)
+	$(INSTALL) -c -m 755 $(STRIP) lspci-udeb $(DESTDIR)-udeb$(SBINDIR)/lspci
 	$(INSTALL) -c -m 755 update-pciids $(DESTDIR)$(SBINDIR)
 	$(INSTALL) -c -m 644 $(PCI_IDS) $(DESTDIR)$(IDSDIR)
-	$(INSTALL) -c -m 644 lspci.8 setpci.8 update-pciids.8 $(DESTDIR)$(MANDIR)/man8
+	$(INSTALL) -c -m 644 lspci.8 setpci.8 update-pciids.8 $(pcimod8-1) $(DESTDIR)$(MANDIR)/man8
 	$(INSTALL) -c -m 644 pcilib.7 $(DESTDIR)$(MANDIR)/man7
 ifeq ($(SHARED),yes)
 	$(DIRINSTALL) -m 755 $(DESTDIR)$(LIBDIR)
@@ -113,8 +123,10 @@
 
 uninstall: all
 	rm -f $(DESTDIR)$(SBINDIR)/lspci $(DESTDIR)$(SBINDIR)/setpci $(DESTDIR)$(SBINDIR)/update-pciids
+	rm -f $(DESTDIR)-udeb$(SBINDIR)/lspci
 	rm -f $(DESTDIR)$(IDSDIR)/$(PCI_IDS)
 	rm -f $(DESTDIR)$(MANDIR)/man8/lspci.8 $(DESTDIR)$(MANDIR)/man8/setpci.8 $(DESTDIR)$(MANDIR)/man8/update-pciids.8
+	rm -f $(DESTDIR)$(SBINDIR)/pcimodules $(DESTDIR)$(MANDIR)/man8/pcimodules.8
 	rm -f $(DESTDIR)$(MANDIR)/man7/pcilib.7
 ifeq ($(SHARED),yes)
 	rm -f $(DESTDIR)$(LIBDIR)/$(PCILIB) $(DESTDIR)$(LIBDIR)/$(LIBNAME).so$(ABI_VERSION)
--- pciutils-3.0.2.orig/update-pciids.sh
+++ pciutils-3.0.2/update-pciids.sh
@@ -1,75 +1,127 @@
 #!/bin/sh
 
-[ "$1" = "-q" ] && quiet=true || quiet=false
+# update-pciids.sh is licensed under the GNU General Public License
+# (GPL) version 2 or above.
+# 
+# Copyright (C) 2008  Anibal Monsalve Salazar <anibal@debian.org>
+# 
+# This program is free software: you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation, either version 2 of the License, or
+# (at your option) any later version.
+# 
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+# 
+# Please read the "COPYING" file in the archive root, or visit
+# http://www.gnu.org/licenses/gpl.html, for information about the GPL.
+#
+# This scipt is a rewrite of a script with the same name by
+# Martin Mares.
 
 set -e
-SRC="http://pciids.sourceforge.net/v2.2/pci.ids"
-DEST=pci.ids
-PCI_COMPRESSED_IDS=
-GREP=grep
-
-# if pci.ids is read-only (because the filesystem is read-only),
-# then just skip this whole process.
-if ! touch ${DEST} >/dev/null 2>&1 ; then
-	${quiet} || echo "${DEST} is read-only, exiting." 1>&2
-	exit 1
-fi
-
-if [ -n "$PCI_COMPRESSED_IDS" ] ; then
-	DECOMP="cat"
-	SRC="$SRC.gz"
-	GREP=zgrep
-elif which bzip2 >/dev/null 2>&1 ; then
-	DECOMP="bzip2 -d"
-	SRC="$SRC.bz2"
-elif which gzip >/dev/null 2>&1 ; then
-	DECOMP="gzip -d"
-	SRC="$SRC.gz"
+
+URL="http://pci-ids.ucw.cz/pci.ids"
+FILE="pci.ids"
+
+RM="/bin/rm"
+MV="/bin/mv"
+SED="/bin/sed"
+GREP="/bin/grep"
+GZIP="/bin/gzip"
+ECHO="/bin/echo"
+CHMOD="/bin/chmod"
+GUNZIP="/bin/gunzip"
+BUNZIP2="/bin/bunzip2"
+TOUCH="/usr/bin/touch"
+WGET="/usr/bin/wget"
+CURL="/usr/bin/curl"
+LYNX="/usr/bin/lynx"
+
+NEWFILE="$FILE.new"
+OLDFILE="$FILE.old"
+
+if [ "$1" = "-q" ]
+then
+    quiet="yes"
 else
-	DECOMP="cat"
+    quiet="no"
 fi
 
-if which curl >/dev/null 2>&1 ; then
-	DL="curl -o $DEST.new $SRC"
-    ${quiet} && DL="$DL -s -S"
-elif which wget >/dev/null 2>&1 ; then
-	DL="wget --no-timestamping -O $DEST.new $SRC"
-	${quiet} && DL="$DL -q"
-elif which lynx >/dev/null 2>&1 ; then
-	DL="eval lynx -source $SRC >$DEST.new"
+if ! $TOUCH $NEWFILE > /dev/null 2>&1
+then
+    $ECHO >&2 "update-pciids: $NEWFILE is read-only"
+    exit 1
+fi
+
+[ -f $NEWFILE ]     && $RM $NEWFILE
+[ -f $NEWFILE.bz2 ] && $RM $NEWFILE.bz2
+[ -f $NEWFILE.gz ]  && $RM $NEWFILE.gz
+
+if [ -x $BUNZIP2 ]
+then
+    EXT=".bz2"
+    UNZIP=$BUNZIP2
+elif [ -x $GUNZIP ]
+then
+    EXT=".gz"
+    UNZIP=$GUNZIP
 else
-	echo >&2 "update-pciids: cannot find curl, wget or lynx"
-	exit 1
+    $ECHO >&2 "update-pciids: cannot find bunzip2 or gunzip"
+    exit 1
 fi
 
-if ! $DL ; then
-	echo >&2 "update-pciids: download failed"
-	rm -f $DEST.new
-	exit 1
+if [ -x $WGET ]
+then
+    $WGET -nv -O $NEWFILE$EXT $URL$EXT > /dev/null 2>&1
+elif [ -x $CURL ]
+then
+    $CURL -o $NEWFILE$EXT $URL$EXT > /dev/null 2>&1
+elif [ -x $LYNX ]
+then
+    $LYNX -source $URL$EXT > $NEWFILE$EXT
+else
+    $ECHO >&2 "update-pciids: cannot find wget, curl or lynx"
+    exit 1
 fi
 
-if ! $DECOMP <$DEST.new >$DEST.neww ; then
-	echo >&2 "update-pciids: decompression failed, probably truncated file"
-	exit 1
+$UNZIP < $NEWFILE$EXT > $NEWFILE
+$RM $NEWFILE$EXT
+
+if ! $GREP > /dev/null "^C " $NEWFILE
+then
+    $ECHO >&2 "update-pciids: missing class info, probably truncated file"
+    exit 1
 fi
 
-if ! $GREP >/dev/null "^C " $DEST.neww ; then
-	echo >&2 "update-pciids: missing class info, probably truncated file"
-	exit 1
+date=$( $GREP "Daily snapshot on " $NEWFILE 2> /dev/null | $SED "s/^.*Daily snapshot on //" )
+
+if [ -z "$date" ]
+then
+    $ECHO >&2 "update-pciids: missing snapshot date, probably truncated file"
+    exit 1
+fi 
+
+if [ -f $FILE ]
+then
+    [ -f $OLDFILE ] && $RM $OLDFILE
+    $MV $FILE $OLDFILE
 fi
 
-if [ -f $DEST ] ; then
-	mv $DEST $DEST.old
-	# --reference is supported only by chmod from GNU file, so let's ignore any errors
-	chmod -f --reference=$DEST.old $DEST.neww 2>/dev/null || true
+$MV $NEWFILE $FILE
+$TOUCH -d "$date" $FILE
+
+if [ -f $FILE.gz ]
+then
+    [ -f $OLDFILE.gz ] && $RM $OLDFILE.gz
+    $MV $FILE.gz $OLDFILE.gz
 fi
-mv $DEST.neww $DEST
-rm $DEST.new
 
-# Older versions did not compress the ids file, so let's make sure we
-# clean that up.
-if [ ${DEST%.gz} != ${DEST} ] ; then
-	rm -f ${DEST%.gz} ${DEST%.gz}.old
+if [ $quiet = "no" ]
+then
+    $ECHO "Downloaded daily snapshot dated $date"
 fi
 
-${quiet} || echo "Done."
+exit 0
--- pciutils-3.0.2.orig/pcimodules.c
+++ pciutils-3.0.2/pcimodules.c
@@ -0,0 +1,185 @@
+/*
+ *	pcimodules:  Load all kernel modules for PCI device currently
+ *      plugged into any PCI slot.
+ *
+ *	Copyright 2000 Yggdrasil Computing, Incorporated
+ *	This file may be copied under the terms and conditions of version 
+ *      two of the GNU General Public License, as published by the Free
+ *      Software Foundation (Cambridge, Massachusetts, USA).
+ *
+ *      This file is based on pciutils/lib/example.c, which has the following
+ *      authorship and copyright statement:
+ *
+ *		Written by Martin Mares and put to public domain. You can do
+ *		with it anything you want, but I don't give you any warranty.
+ */
+
+#include <stdlib.h>
+#include <stdio.h>
+#include <malloc.h>
+#include <string.h>
+#include <unistd.h>
+#include <sys/utsname.h>
+#include <sys/param.h>
+#include <sys/types.h>
+
+#define _GNU_SOURCE
+#include <getopt.h>
+
+#include "pciutils.h"
+
+const char program_name[] = "pcimodules";
+
+#define MODDIR	"/lib/modules"
+#define PCIMAP	"modules.pcimap"
+
+#define LINELENGTH	8000 
+
+#define DEVICE_ANY	0xffffffff
+#define VENDOR_ANY	0xffffffff
+
+#include "lib/pci.h"
+
+struct pcimap_entry {
+	unsigned int vendor, subsys_vendor, dev, subsys_dev, class, class_mask;
+	char *module;
+	struct pcimap_entry *next;
+};
+
+static struct pcimap_entry *pcimap_list = NULL;
+
+#define OPT_STRING "h"
+static struct option long_options[] = {
+	{"class",	required_argument,	NULL, 'c'},
+	{"classmask",	required_argument,	NULL, 'm'},
+	{"help",	no_argument,		NULL, 'h'},
+	{ 0,		0,			0, 	0}
+};
+
+static unsigned long desired_class;
+static unsigned long desired_classmask; /* Default is 0: accept all classes.*/
+
+void
+read_pcimap(void)
+{
+	struct utsname utsname;
+	char filename[MAXPATHLEN];
+	FILE *pcimap_file;
+	char line[LINELENGTH];
+	struct pcimap_entry *entry;
+	unsigned int driver_data;
+	char *prevmodule = "";
+	char module[LINELENGTH];
+
+	if (uname(&utsname) < 0) {
+		perror("uname");
+		exit(1);
+	}
+	sprintf(filename, "%s/%s/%s", MODDIR, utsname.release, PCIMAP);
+	if ((pcimap_file = fopen(filename, "r")) == NULL) {
+		perror(filename);
+		exit(1);
+	}
+
+	while(fgets(line, LINELENGTH, pcimap_file) != NULL) {
+		if (line[0] == '#')
+			continue;
+
+		entry = xmalloc(sizeof(struct pcimap_entry));
+
+		if (sscanf(line, "%s 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x",
+			   module,
+			   &entry->vendor, &entry->dev,
+			   &entry->subsys_vendor, &entry->subsys_dev,
+			   &entry->class, &entry->class_mask,
+			   &driver_data) != 8) {
+			fprintf (stderr,
+				"modules.pcimap unparsable line: %s.\n", line);
+			free(entry);
+			continue;
+		}
+
+		/* Optimize memory allocation a bit, in case someday we
+		   have Linux systems with ~100,000 modules.  It also
+		   allows us to just compare pointers to avoid trying
+		   to load a module twice. */
+		if (strcmp(module, prevmodule) != 0) {
+			prevmodule = xmalloc(strlen(module)+1);
+			strcpy(prevmodule, module);
+		}
+		entry->module = prevmodule;
+		entry->next = pcimap_list;
+		pcimap_list = entry;
+	}
+	fclose(pcimap_file);
+}
+
+/* Return a filled in pci_access->dev tree, with the device classes
+   stored in dev->aux.
+*/
+static void
+match_pci_modules(void)
+{
+	struct pci_access *pacc;
+	struct pci_dev *dev;
+	unsigned int class, subsys_dev, subsys_vendor;
+	struct pcimap_entry *map;
+	const char *prevmodule = "";
+
+	pacc = pci_alloc();		/* Get the pci_access structure */
+	/* Set all options you want -- here we stick with the defaults */
+	pci_init(pacc);		/* Initialize the PCI library */
+	pci_scan_bus(pacc);	/* We want to get the list of devices */
+  	for(dev=pacc->devices; dev; dev=dev->next) {
+		pci_fill_info(dev, PCI_FILL_IDENT | PCI_FILL_BASES);
+		class = (pci_read_word(dev, PCI_CLASS_DEVICE) << 8)
+			| pci_read_byte(dev, PCI_CLASS_PROG);
+		subsys_dev = pci_read_word(dev, PCI_SUBSYSTEM_ID);
+		subsys_vendor = pci_read_word(dev,PCI_SUBSYSTEM_VENDOR_ID);
+		for(map = pcimap_list; map != NULL; map = map->next) {
+			if (((map->class ^ class) & map->class_mask) == 0 &&
+			    ((desired_class ^ class) & desired_classmask)==0 &&
+			    (map->dev == DEVICE_ANY ||
+			     map->dev == dev->device_id) &&
+			    (map->vendor == VENDOR_ANY ||
+			     map->vendor == dev->vendor_id) &&
+			    (map->subsys_dev == DEVICE_ANY ||
+			     map->subsys_dev == subsys_dev) &&
+			    (map->subsys_vendor == VENDOR_ANY ||
+			     map->subsys_vendor == subsys_vendor) &&
+			    prevmodule != map->module) {
+				printf("%s\n", map->module);
+				prevmodule = map->module;
+			}
+		}
+
+	}
+	pci_cleanup(pacc);
+}
+
+int
+main (int argc, char **argv)
+{
+	int opt_index = 0;
+	int opt;
+
+	while ((opt = getopt_long(argc, argv, OPT_STRING, long_options,
+		           &opt_index)) != -1) {
+		switch(opt) {
+			case 'c':
+				desired_class = strtol(optarg, NULL, 0);
+				break;
+			case 'm':
+				desired_classmask = strtol(optarg, NULL, 0);
+				break;
+			case 'h':
+				printf ("Usage: pcimodules [--help]\n"
+					"  Lists kernel modules corresponding to PCI devices currently plugged"
+					"  into the computer.\n");
+		}
+	}	
+
+	read_pcimap();
+	match_pci_modules();
+	return 0;
+}
--- pciutils-3.0.2.orig/lib/Makefile
+++ pciutils-3.0.2/lib/Makefile
@@ -42,18 +42,20 @@
 OBJS += nbsd-libpci
 endif
 
-all: $(PCILIB) $(PCILIBPC)
+PCILIBA=libpci.a
 
-ifeq ($(SHARED),no)
-$(PCILIB): $(addsuffix .o,$(OBJS))
+all: $(PCILIB) $(PCILIBA) $(PCILIBPC)
+
+# ifeq ($(SHARED),no)
+$(PCILIBA): $(addsuffix .o,$(OBJS))
 	rm -f $@
 	$(AR) rcs $@ $^
 	$(RANLIB) $@
-else
+# else
 CFLAGS += -fPIC -fvisibility=hidden
 $(PCILIB): $(addsuffix .o,$(OBJS))
 	$(CC) -shared $(SONAME) -Wl,--version-script=libpci.ver -o $@ $^ $(LIB_LDLIBS)
-endif
+# endif
 
 $(PCILIBPC): libpci.pc.in
 	sed <$< >$@ -e 's,@PREFIX@,$(PREFIX),' \
